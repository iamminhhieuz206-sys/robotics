import cv2
import os
import albumentations as A

folder = r"D:\Robotic\Banh_cosy"

# Pipeline augmentation
transform = A.Compose([
    A.HorizontalFlip(p=0.5),
    A.VerticalFlip(p=0.2),
    A.RandomBrightnessContrast(p=0.5),
    A.Rotate(limit=20, p=0.5)
], bbox_params=A.BboxParams(format='yolo', label_fields=['class_labels']))

# Lấy tất cả ảnh và label
images = sorted([f for f in os.listdir(folder) if f.lower().endswith(('.jpg','.png'))],
                key=lambda x: int(''.join(filter(str.isdigit, x))))

num_aug_per_image = 3  # số ảnh mới mỗi ảnh gốc

# Tìm số bắt đầu cho ảnh mới (số lớn hơn tất cả số hiện có)
existing_numbers = [int(''.join(filter(str.isdigit, f))) for f in os.listdir(folder) if f.lower().endswith(('.jpg','.png'))]
start_number = max(existing_numbers) + 1

for img_file in images:
    img_path = os.path.join(folder, img_file)
    label_path = os.path.join(folder, os.path.splitext(img_file)[0]+".txt")

    # Đọc ảnh
    img = cv2.imread(img_path)

    # Đọc label YOLO
    bboxes = []
    class_labels = []
    with open(label_path, "r") as f:
        for line in f:
            cls, x, y, w, h = map(float, line.strip().split())
            bboxes.append([x, y, w, h])
            class_labels.append(int(cls))

    # Tạo augmentation nhiều lần
    for i in range(num_aug_per_image):
        augmented = transform(image=img, bboxes=bboxes, class_labels=class_labels)
        aug_img = augmented['image']
        aug_bboxes = augmented['bboxes']
        aug_labels = augmented['class_labels']

        # Lưu trực tiếp trong folder gốc với số tiếp theo
        new_img_path = os.path.join(folder, f"Banh_cosy_{start_number}.jpg")
        new_label_path = os.path.join(folder, f"Banh_cosy_{start_number}.txt")

        cv2.imwrite(new_img_path, aug_img)
        with open(new_label_path, "w") as f:
            for cls, bbox in zip(aug_labels, aug_bboxes):
                x, y, w, h = bbox
                f.write(f"{cls} {x} {y} {w} {h}\n")

        start_number += 1  # tăng số tiếp theo

print(f"Xong augmentation, mỗi ảnh gốc tạo ra {num_aug_per_image} ảnh mới ngay trong folder gốc!")
