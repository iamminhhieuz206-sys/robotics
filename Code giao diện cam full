import sys
from PySide6.QtWidgets import (QApplication, QMainWindow, QWidget, QVBoxLayout, 
                               QHBoxLayout, QPushButton, QLabel, QComboBox, QFrame,
                               QListWidget, QListWidgetItem, QCheckBox)
from PySide6.QtCore import Qt, QThread, Signal, QTimer, QPropertyAnimation, QEasingCurve, Property
from PySide6.QtGui import QImage, QPixmap, QPalette, QColor
import cv2
from ultralytics import YOLO
import numpy as np


class VideoThread(QThread):
    """Thread ri√™ng ƒë·ªÉ x·ª≠ l√Ω video v√† YOLO detection"""
    change_pixmap_signal = Signal(np.ndarray)
    
    def __init__(self):
        super().__init__()
        self.running = False
        self.cap = None
        self.model = None
        self.selected_classes = []  # Danh s√°ch c√°c class ƒë∆∞·ª£c ch·ªçn
        
    def load_model(self, model_path):
        """Load YOLO model"""
        try:
            self.model = YOLO(model_path)
            return True
        except Exception as e:
            print(f"Error loading model: {e}")
            return False
    
    def run(self):
        """V√≤ng l·∫∑p ch√≠nh c·ªßa thread"""
        self.cap = cv2.VideoCapture(0)
        self.cap.set(cv2.CAP_PROP_FRAME_WIDTH, 1280)
        self.cap.set(cv2.CAP_PROP_FRAME_HEIGHT, 720)
        
        while self.running:
            ret, frame = self.cap.read()
            if ret and self.model:
                # Ch·∫°y YOLO detection
                results = self.model.predict(frame, conf=0.6, iou=0.3, verbose=False)
                
                # V·∫Ω bounding box theo object ƒë√£ ch·ªçn
                annotated_frame = frame.copy()
                
                for result in results:
                    boxes = result.boxes
                    for box in boxes:
                        # L·∫•y th√¥ng tin class
                        cls_id = int(box.cls[0])
                        cls_name = result.names[cls_id]
                        
                        # Ch·ªâ v·∫Ω n·∫øu danh s√°ch r·ªóng (all) ho·∫∑c class n·∫±m trong danh s√°ch ƒë√£ ch·ªçn
                        if len(self.selected_classes) == 0 or cls_name in self.selected_classes:
                            # L·∫•y t·ªça ƒë·ªô box
                            x1, y1, x2, y2 = map(int, box.xyxy[0])
                            conf = float(box.conf[0])
                            
                            # V·∫Ω bounding box
                            cv2.rectangle(annotated_frame, (x1, y1), (x2, y2), (0, 255, 0), 2)
                            
                            # V·∫Ω label
                            label = f"{cls_name}: {conf:.2f}"
                            (w, h), _ = cv2.getTextSize(label, cv2.FONT_HERSHEY_SIMPLEX, 0.6, 2)
                            cv2.rectangle(annotated_frame, (x1, y1 - h - 10), (x1 + w, y1), (0, 255, 0), -1)
                            cv2.putText(annotated_frame, label, (x1, y1 - 5), 
                                       cv2.FONT_HERSHEY_SIMPLEX, 0.6, (0, 0, 0), 2)
                
                self.change_pixmap_signal.emit(annotated_frame)
        
        if self.cap:
            self.cap.release()
    
    def stop(self):
        """D·ª´ng thread"""
        self.running = False
        self.wait()


class AnimatedButton(QPushButton):
    """Button v·ªõi hi·ªáu ·ª©ng hover animation"""
    def __init__(self, text, parent=None):
        super().__init__(text, parent)
        self._scale = 1.0
        self.setup_style()
        
    def setup_style(self):
        self.setStyleSheet("""
            QPushButton {
                background: qlineargradient(x1:0, y1:0, x2:1, y2:1,
                                           stop:0 #667eea, stop:1 #764ba2);
                color: white;
                border: none;
                border-radius: 12px;
                padding: 12px 24px;
                font-size: 14px;
                font-weight: bold;
            }
            QPushButton:hover {
                background: qlineargradient(x1:0, y1:0, x2:1, y2:1,
                                           stop:0 #764ba2, stop:1 #667eea);
            }
            QPushButton:pressed {
                background: qlineargradient(x1:0, y1:0, x2:1, y2:1,
                                           stop:0 #5568d3, stop:1 #6341a0);
            }
            QPushButton:disabled {
                background: #cccccc;
                color: #666666;
            }
        """)
    
    def enterEvent(self, event):
        self.animate_scale(1.05)
        super().enterEvent(event)
    
    def leaveEvent(self, event):
        self.animate_scale(1.0)
        super().leaveEvent(event)
    
    def animate_scale(self, target_scale):
        animation = QPropertyAnimation(self, b"scale")
        animation.setDuration(200)
        animation.setStartValue(self._scale)
        animation.setEndValue(target_scale)
        animation.setEasingCurve(QEasingCurve.Type.OutCubic)
        animation.start()
        self._animation = animation
    
    def get_scale(self):
        return self._scale
    
    def set_scale(self, scale):
        self._scale = scale
        self.setStyleSheet(self.styleSheet() + f"transform: scale({scale});")
    
    scale = Property(float, get_scale, set_scale)


class MainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        self.setWindowTitle("YOLOv8 Object Detection - Modern GUI")
        self.setMinimumSize(1400, 900)
        
        # Thi·∫øt l·∫≠p theme t·ªëi hi·ªán ƒë·∫°i
        self.setup_theme()
        
        # Thread video
        self.video_thread = VideoThread()
        self.video_thread.change_pixmap_signal.connect(self.update_image)
        
        # Load model
        model_loaded = self.video_thread.load_model(r"D:\Robotic\best.pt")
        if not model_loaded:
            print("Warning: Could not load model")
        
        # Tr·∫°ng th√°i
        self.camera_running = False
        self.available_classes = []
        
        # T·∫°o UI
        self.setup_ui()
        
    def setup_theme(self):
        """Thi·∫øt l·∫≠p theme t·ªëi hi·ªán ƒë·∫°i"""
        self.setStyleSheet("""
            QMainWindow {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                                           stop:0 #0f0c29, stop:0.5 #302b63, stop:1 #24243e);
            }
            QLabel {
                color: white;
                font-size: 14px;
            }
            QComboBox {
                background-color: #2d2d44;
                color: white;
                border: 2px solid #667eea;
                border-radius: 8px;
                padding: 8px 12px;
                font-size: 14px;
                min-width: 200px;
            }
            QComboBox:hover {
                border: 2px solid #764ba2;
            }
            QComboBox::drop-down {
                border: none;
                width: 30px;
            }
            QComboBox::down-arrow {
                image: none;
                border-left: 5px solid transparent;
                border-right: 5px solid transparent;
                border-top: 8px solid white;
                margin-right: 10px;
            }
            QComboBox QAbstractItemView {
                background-color: #2d2d44;
                color: white;
                selection-background-color: #667eea;
                border: 2px solid #667eea;
                border-radius: 8px;
            }
            QListWidget {
                background-color: #2d2d44;
                color: white;
                border: 2px solid #667eea;
                border-radius: 12px;
                padding: 10px;
                font-size: 14px;
            }
            QListWidget::item {
                padding: 8px;
                border-radius: 6px;
                margin: 2px;
            }
            QListWidget::item:hover {
                background-color: rgba(102, 126, 234, 0.3);
            }
            QListWidget::item:selected {
                background-color: rgba(102, 126, 234, 0.5);
            }
            QCheckBox {
                color: white;
                font-size: 14px;
                spacing: 8px;
            }
            QCheckBox::indicator {
                width: 20px;
                height: 20px;
                border: 2px solid #667eea;
                border-radius: 5px;
                background-color: #2d2d44;
            }
            QCheckBox::indicator:hover {
                border: 2px solid #764ba2;
                background-color: rgba(102, 126, 234, 0.2);
            }
            QCheckBox::indicator:checked {
                background-color: #667eea;
                border: 2px solid #764ba2;
                image: none;
            }
            QCheckBox::indicator:checked:after {
                content: "‚úì";
            }
        """)
    
    def setup_ui(self):
        """T·∫°o giao di·ªán"""
        central_widget = QWidget()
        self.setCentralWidget(central_widget)
        main_layout = QHBoxLayout(central_widget)  # ƒê·ªïi sang HBoxLayout
        main_layout.setSpacing(20)
        main_layout.setContentsMargins(30, 30, 30, 30)
        
        # Left panel - Controls and Object Selection
        left_panel = QWidget()
        left_layout = QVBoxLayout(left_panel)
        left_layout.setSpacing(20)
        left_panel.setMaximumWidth(400)
        left_panel.setStyleSheet("""
            QWidget {
                background: rgba(45, 45, 68, 0.5);
                border-radius: 15px;
            }
        """)
        
        # Header
        header_label = QLabel("üéØ YOLOv8 Detection")
        header_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        header_label.setStyleSheet("""
            font-size: 24px;
            font-weight: bold;
            color: white;
            padding: 20px;
            background: qlineargradient(x1:0, y1:0, x2:1, y2:0,
                                       stop:0 rgba(102, 126, 234, 0.3), 
                                       stop:1 rgba(118, 75, 162, 0.3));
            border-radius: 15px;
        """)
        left_layout.addWidget(header_label)
        
        # Control buttons
        control_frame = QFrame()
        control_frame.setStyleSheet("""
            QFrame {
                background: rgba(30, 30, 50, 0.7);
                border-radius: 12px;
                padding: 15px;
            }
        """)
        control_layout = QVBoxLayout(control_frame)
        control_layout.setSpacing(12)
        
        self.btn_open = AnimatedButton("üì∑ Open Camera")
        self.btn_open.clicked.connect(self.start_camera)
        control_layout.addWidget(self.btn_open)
        
        self.btn_close = AnimatedButton("‚èπÔ∏è Close Camera")
        self.btn_close.clicked.connect(self.stop_camera)
        self.btn_close.setEnabled(False)
        control_layout.addWidget(self.btn_close)
        
        left_layout.addWidget(control_frame)
        
        # Object selection panel
        selection_frame = QFrame()
        selection_frame.setStyleSheet("""
            QFrame {
                background: rgba(30, 30, 50, 0.7);
                border-radius: 12px;
                padding: 15px;
            }
        """)
        selection_layout = QVBoxLayout(selection_frame)
        selection_layout.setSpacing(10)
        
        # Title
        title_label = QLabel("üìã Select Objects to Detect:")
        title_label.setStyleSheet("""
            font-size: 16px;
            font-weight: bold;
            color: #667eea;
            padding: 5px;
        """)
        selection_layout.addWidget(title_label)
        
        # Select All / Deselect All buttons
        select_buttons_layout = QHBoxLayout()
        
        self.btn_select_all = QPushButton("‚úì Select All")
        self.btn_select_all.clicked.connect(self.select_all_objects)
        self.btn_select_all.setStyleSheet("""
            QPushButton {
                background-color: rgba(102, 126, 234, 0.3);
                color: white;
                border: 1px solid #667eea;
                border-radius: 8px;
                padding: 8px;
                font-size: 12px;
            }
            QPushButton:hover {
                background-color: rgba(102, 126, 234, 0.5);
            }
        """)
        select_buttons_layout.addWidget(self.btn_select_all)
        
        self.btn_deselect_all = QPushButton("‚úó Deselect All")
        self.btn_deselect_all.clicked.connect(self.deselect_all_objects)
        self.btn_deselect_all.setStyleSheet("""
            QPushButton {
                background-color: rgba(118, 75, 162, 0.3);
                color: white;
                border: 1px solid #764ba2;
                border-radius: 8px;
                padding: 8px;
                font-size: 12px;
            }
            QPushButton:hover {
                background-color: rgba(118, 75, 162, 0.5);
            }
        """)
        select_buttons_layout.addWidget(self.btn_deselect_all)
        
        selection_layout.addLayout(select_buttons_layout)
        
        # List widget v·ªõi checkboxes
        self.object_list = QListWidget()
        self.object_list.setMinimumHeight(300)
        selection_layout.addWidget(self.object_list)
        
        # Selected count label
        self.selected_count_label = QLabel("Selected: 0 objects (All)")
        self.selected_count_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        self.selected_count_label.setStyleSheet("""
            font-size: 13px;
            color: #667eea;
            padding: 8px;
            background: rgba(102, 126, 234, 0.2);
            border-radius: 8px;
        """)
        selection_layout.addWidget(self.selected_count_label)
        
        left_layout.addWidget(selection_frame)
        
        # Status
        self.status_label = QLabel("Status: Ready")
        self.status_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        self.status_label.setStyleSheet("""
            font-size: 14px;
            padding: 12px;
            background: rgba(102, 126, 234, 0.2);
            border-radius: 10px;
        """)
        left_layout.addWidget(self.status_label)
        
        left_layout.addStretch()
        
        # Right panel - Video display
        right_panel = QWidget()
        right_layout = QVBoxLayout(right_panel)
        right_layout.setSpacing(0)
        right_layout.setContentsMargins(0, 0, 0, 0)
        
        self.video_label = QLabel()
        self.video_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        self.video_label.setStyleSheet("""
            QLabel {
                background-color: #1a1a2e;
                border: 3px solid #667eea;
                border-radius: 15px;
                min-height: 600px;
            }
        """)
        self.video_label.setText("üìπ Camera feed will appear here")
        right_layout.addWidget(self.video_label)
        
        # Add panels to main layout
        main_layout.addWidget(left_panel, 1)
        main_layout.addWidget(right_panel, 3)
        
        # Animation cho status
        self.setup_status_animation()
    
    def setup_status_animation(self):
        """T·∫°o hi·ªáu ·ª©ng nh·∫•p nh√°y cho status khi camera ƒëang ch·∫°y"""
        self.status_timer = QTimer()
        self.status_timer.timeout.connect(self.animate_status)
        self.status_opacity = 1.0
        self.status_direction = -1
    
    def animate_status(self):
        """Animation cho status label"""
        self.status_opacity += 0.05 * self.status_direction
        if self.status_opacity <= 0.5:
            self.status_direction = 1
        elif self.status_opacity >= 1.0:
            self.status_direction = -1
        
        self.status_label.setStyleSheet(f"""
            font-size: 16px;
            padding: 15px;
            background: rgba(102, 126, 234, {self.status_opacity * 0.4});
            border-radius: 10px;
            color: rgba(255, 255, 255, {self.status_opacity});
        """)
    
    def start_camera(self):
        """B·∫Øt ƒë·∫ßu camera v·ªõi animation"""
        self.camera_running = True
        self.video_thread.running = True
        self.video_thread.start()
        
        self.btn_open.setEnabled(False)
        self.btn_close.setEnabled(True)
        self.status_label.setText("üî¥ Status: Camera Running...")
        self.status_timer.start(50)
        
        # Animation fade in cho video label
        self.fade_animation(self.video_label, 0, 1)
    
    def stop_camera(self):
        """D·ª´ng camera v·ªõi animation"""
        self.camera_running = False
        self.video_thread.stop()
        
        self.btn_open.setEnabled(True)
        self.btn_close.setEnabled(False)
        self.status_label.setText("‚è∏Ô∏è Status: Camera Stopped")
        self.status_label.setStyleSheet("""
            font-size: 16px;
            padding: 15px;
            background: rgba(102, 126, 234, 0.2);
            border-radius: 10px;
        """)
        self.status_timer.stop()
        
        self.video_label.setText("üìπ Camera feed will appear here")
    
    def fade_animation(self, widget, start_value, end_value):
        """T·∫°o hi·ªáu ·ª©ng fade"""
        animation = QPropertyAnimation(widget, b"windowOpacity")
        animation.setDuration(300)
        animation.setStartValue(start_value)
        animation.setEndValue(end_value)
        animation.setEasingCurve(QEasingCurve.Type.InOutQuad)
        animation.start()
        self._fade_animation = animation
    
    def update_image(self, cv_img):
        """C·∫≠p nh·∫≠t h√¨nh ·∫£nh l√™n GUI"""
        # C·∫≠p nh·∫≠t danh s√°ch classes n·∫øu c·∫ßn
        if self.video_thread.model and self.object_list.count() == 0:
            self.available_classes = list(self.video_thread.model.names.values())
            for cls_name in self.available_classes:
                item = QListWidgetItem()
                checkbox = QCheckBox(cls_name)
                checkbox.stateChanged.connect(self.on_checkbox_changed)
                self.object_list.addItem(item)
                self.object_list.setItemWidget(item, checkbox)
                # T·ª± ƒë·ªông check all khi kh·ªüi t·∫°o
                checkbox.setChecked(True)
        
        # Convert OpenCV image to Qt format
        rgb_image = cv2.cvtColor(cv_img, cv2.COLOR_BGR2RGB)
        h, w, ch = rgb_image.shape
        bytes_per_line = ch * w
        qt_image = QImage(rgb_image.data, w, h, bytes_per_line, QImage.Format.Format_RGB888)
        
        # Scale ƒë·ªÉ fit v√†o label
        scaled_pixmap = QPixmap.fromImage(qt_image).scaled(
            self.video_label.size(), 
            Qt.AspectRatioMode.KeepAspectRatio,
            Qt.TransformationMode.SmoothTransformation
        )
        
        self.video_label.setPixmap(scaled_pixmap)
    
    def on_checkbox_changed(self):
        """X·ª≠ l√Ω khi checkbox thay ƒë·ªïi"""
        selected = []
        for i in range(self.object_list.count()):
            item = self.object_list.item(i)
            checkbox = self.object_list.itemWidget(item)
            if checkbox.isChecked():
                selected.append(checkbox.text())
        
        # C·∫≠p nh·∫≠t danh s√°ch selected v√†o thread
        self.video_thread.selected_classes = selected
        
        # C·∫≠p nh·∫≠t label hi·ªÉn th·ªã s·ªë l∆∞·ª£ng
        if len(selected) == 0:
            self.selected_count_label.setText("Selected: 0 objects (All)")
        elif len(selected) == len(self.available_classes):
            self.selected_count_label.setText(f"Selected: All {len(selected)} objects")
        else:
            self.selected_count_label.setText(f"Selected: {len(selected)} object(s)")
        
        # Animation cho label
        self.animate_label(self.selected_count_label)
    
    def select_all_objects(self):
        """Ch·ªçn t·∫•t c·∫£ objects"""
        for i in range(self.object_list.count()):
            item = self.object_list.item(i)
            checkbox = self.object_list.itemWidget(item)
            checkbox.setChecked(True)
    
    def deselect_all_objects(self):
        """B·ªè ch·ªçn t·∫•t c·∫£ objects"""
        for i in range(self.object_list.count()):
            item = self.object_list.item(i)
            checkbox = self.object_list.itemWidget(item)
            checkbox.setChecked(False)
    
    def animate_label(self, label):
        """Animation cho label khi thay ƒë·ªïi"""
        animation = QPropertyAnimation(label, b"geometry")
        animation.setDuration(200)
        current_geo = label.geometry()
        animation.setStartValue(current_geo)
        animation.setEndValue(current_geo)
        animation.setEasingCurve(QEasingCurve.Type.OutElastic)
        animation.start()
        self._label_animation = animation
    
    def closeEvent(self, event):
        """X·ª≠ l√Ω khi ƒë√≥ng ·ª©ng d·ª•ng"""
        self.video_thread.stop()
        event.accept()


if __name__ == "__main__":
    app = QApplication(sys.argv)
    window = MainWindow()
    window.show()
    sys.exit(app.exec())
