import cv2
import os

# Folder ·∫£nh v√† folder l∆∞u label
image_folder = r"D:\Robotic\Banh_cosy"
label_folder = r"D:\Robotic\Banh_cosy"
os.makedirs(label_folder, exist_ok=True)

# Class index (Banh_cosy = 0)
class_index = 0

# ====== CH·ªàNH ·ªû ƒê√ÇY ======
start_index = 401  # b·∫Øt ƒë·∫ßu t·ª´ Banh_cosy_401
# ========================

# L·∫•y danh s√°ch ·∫£nh, s·∫Øp x·∫øp theo th·ª© t·ª± s·ªë v√† l·ªçc >= 401
images = sorted(
    [f for f in os.listdir(image_folder)
     if f.lower().endswith((".jpg", ".png"))
     and int(''.join(filter(str.isdigit, f))) >= start_index],
    key=lambda x: int(''.join(filter(str.isdigit, x)))
)

# K√≠ch th∆∞·ªõc t·ªëi ƒëa ƒë·ªÉ hi·ªÉn th·ªã
max_width = 1000
max_height = 700

def crop_and_label(img_path):
    img = cv2.imread(img_path)
    orig_h, orig_w = img.shape[:2]

    # Resize ·∫£nh hi·ªÉn th·ªã n·∫øu qu√° to
    scale = min(max_width/orig_w, max_height/orig_h, 1)
    disp_img = cv2.resize(img, (int(orig_w*scale), int(orig_h*scale)))

    # Ch·ªçn ROI
    r = cv2.selectROI("Select ROI and press ENTER", disp_img, False)
    cv2.destroyAllWindows()

    # Chuy·ªÉn ROI v·ªÅ t·ªça ƒë·ªô ·∫£nh g·ªëc
    x, y, w, h = [int(v/scale) for v in r]

    # Chu·∫©n YOLO
    x_center = (x + w/2) / orig_w
    y_center = (y + h/2) / orig_h
    w_norm = w / orig_w
    h_norm = h / orig_h

    # L∆∞u label
    label_path = os.path.join(
        label_folder,
        os.path.splitext(os.path.basename(img_path))[0] + ".txt"
    )
    with open(label_path, "w") as f:
        f.write(f"{class_index} {x_center} {y_center} {w_norm} {h_norm}\n")

    print(f"‚úî L∆∞u label: {label_path}")

# L·∫∑p qua ·∫£nh
for img_file in images:
    img_path = os.path.join(image_folder, img_file)
    crop_and_label(img_path)

print("üéâ Xong t·∫•t c·∫£ ·∫£nh t·ª´ Banh_cosy_401!")
